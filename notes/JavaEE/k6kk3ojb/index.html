<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.15" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;if (um === 'dark' || (um !== 'light' && sm)) {document.documentElement.classList.add('dark');}})();</script><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><link rel="icon" href="/images/logo.png"><title>13-集成Redis的应用问题&解决方案 | chgoh7的文档&blog</title><meta name="description" content=""><link rel="preload" href="/assets/style-CbKOK9DL.css" as="style"><link rel="stylesheet" href="/assets/style-CbKOK9DL.css"><link rel="modulepreload" href="/assets/app-CpHCUsvl.js"><link rel="modulepreload" href="/assets/index.html-f5fsyUVt.js"><link rel="prefetch" href="/assets/index.html-YRZzROg5.js" as="script"><link rel="prefetch" href="/assets/index.html-NrBQKQNB.js" as="script"><link rel="prefetch" href="/assets/index.html-DqjwSWqP.js" as="script"><link rel="prefetch" href="/assets/index.html-TK7gfzpC.js" as="script"><link rel="prefetch" href="/assets/index.html-CHszOb8V.js" as="script"><link rel="prefetch" href="/assets/index.html-Cy8DgBb8.js" as="script"><link rel="prefetch" href="/assets/index.html-CiP4PSm3.js" as="script"><link rel="prefetch" href="/assets/index.html-_aFXf05F.js" as="script"><link rel="prefetch" href="/assets/index.html-CpMP3nW3.js" as="script"><link rel="prefetch" href="/assets/index.html-W8wFIpTH.js" as="script"><link rel="prefetch" href="/assets/index.html-PPDt3edx.js" as="script"><link rel="prefetch" href="/assets/index.html-mqdZbH19.js" as="script"><link rel="prefetch" href="/assets/index.html-DuyjCIdH.js" as="script"><link rel="prefetch" href="/assets/index.html-DASjYxoI.js" as="script"><link rel="prefetch" href="/assets/index.html-D-U9o6dt.js" as="script"><link rel="prefetch" href="/assets/index.html-D1WmiAWr.js" as="script"><link rel="prefetch" href="/assets/index.html-B4zOlf-o.js" as="script"><link rel="prefetch" href="/assets/index.html-DIUfwFB6.js" as="script"><link rel="prefetch" href="/assets/index.html-NKxImd6S.js" as="script"><link rel="prefetch" href="/assets/index.html-BNrIhYZn.js" as="script"><link rel="prefetch" href="/assets/index.html-BRya09XV.js" as="script"><link rel="prefetch" href="/assets/index.html-DI8iFrbd.js" as="script"><link rel="prefetch" href="/assets/index.html-BCV213NC.js" as="script"><link rel="prefetch" href="/assets/index.html-D-hMyBOo.js" as="script"><link rel="prefetch" href="/assets/index.html-BhMcxscP.js" as="script"><link rel="prefetch" href="/assets/index.html-6i7j4nen.js" as="script"><link rel="prefetch" href="/assets/index.html-DOrNX2-i.js" as="script"><link rel="prefetch" href="/assets/index.html-nw_xfZxA.js" as="script"><link rel="prefetch" href="/assets/index.html-Db8eXKA-.js" as="script"><link rel="prefetch" href="/assets/index.html-BuxXy5_Q.js" as="script"><link rel="prefetch" href="/assets/index.html-DYr5r313.js" as="script"><link rel="prefetch" href="/assets/index.html-DOvfVOgb.js" as="script"><link rel="prefetch" href="/assets/index.html-Da1mXYmE.js" as="script"><link rel="prefetch" href="/assets/index.html-DN4idpcy.js" as="script"><link rel="prefetch" href="/assets/index.html-BUJqMSsx.js" as="script"><link rel="prefetch" href="/assets/index.html-DSiTqw1G.js" as="script"><link rel="prefetch" href="/assets/index.html-BZSWMUgo.js" as="script"><link rel="prefetch" href="/assets/index.html-503jeEQb.js" as="script"><link rel="prefetch" href="/assets/index.html-BsElD8W8.js" as="script"><link rel="prefetch" href="/assets/index.html-BCKWm67Q.js" as="script"><link rel="prefetch" href="/assets/index.html-COaX7ID7.js" as="script"><link rel="prefetch" href="/assets/index.html-DPBzDMyT.js" as="script"><link rel="prefetch" href="/assets/index.html-DKyH0BYr.js" as="script"><link rel="prefetch" href="/assets/index.html-vzOnaw1a.js" as="script"><link rel="prefetch" href="/assets/index.html-CrWf9akt.js" as="script"><link rel="prefetch" href="/assets/index.html-B9nLRpiY.js" as="script"><link rel="prefetch" href="/assets/index.html-DyyKD430.js" as="script"><link rel="prefetch" href="/assets/index.html-QAp2cLXL.js" as="script"><link rel="prefetch" href="/assets/index.html-BB9CrDpF.js" as="script"><link rel="prefetch" href="/assets/index.html-Ep7wlW8G.js" as="script"><link rel="prefetch" href="/assets/index.html-U1u13zIt.js" as="script"><link rel="prefetch" href="/assets/index.html-CDjnEdQ6.js" as="script"><link rel="prefetch" href="/assets/index.html-D3CPbm6j.js" as="script"><link rel="prefetch" href="/assets/index.html-CjP1Ao0x.js" as="script"><link rel="prefetch" href="/assets/index.html-B6CInOtg.js" as="script"><link rel="prefetch" href="/assets/index.html-CHtba1DH.js" as="script"><link rel="prefetch" href="/assets/index.html-BurxFY5v.js" as="script"><link rel="prefetch" href="/assets/index.html-BF8pAhqt.js" as="script"><link rel="prefetch" href="/assets/index.html-BGw-XMmu.js" as="script"><link rel="prefetch" href="/assets/index.html-C6WyLDLM.js" as="script"><link rel="prefetch" href="/assets/index.html-CPbQMLmm.js" as="script"><link rel="prefetch" href="/assets/index.html-CmSQmT-g.js" as="script"><link rel="prefetch" href="/assets/index.html-DcXtiCvn.js" as="script"><link rel="prefetch" href="/assets/index.html-BbV1c1lP.js" as="script"><link rel="prefetch" href="/assets/index.html-BntcOxPh.js" as="script"><link rel="prefetch" href="/assets/index.html-Baszi0Xv.js" as="script"><link rel="prefetch" href="/assets/index.html-CwhZ6McK.js" as="script"><link rel="prefetch" href="/assets/index.html-WPALt_Tx.js" as="script"><link rel="prefetch" href="/assets/index.html-CdBkguIX.js" as="script"><link rel="prefetch" href="/assets/index.html-CwjUbYnT.js" as="script"><link rel="prefetch" href="/assets/index.html-mN4RNmlh.js" as="script"><link rel="prefetch" href="/assets/index.html-CsJcW3wq.js" as="script"><link rel="prefetch" href="/assets/index.html-taIIRr78.js" as="script"><link rel="prefetch" href="/assets/index.html-DF8JaKXw.js" as="script"><link rel="prefetch" href="/assets/index.html-BakRoQjy.js" as="script"><link rel="prefetch" href="/assets/index.html-CZlU0awI.js" as="script"><link rel="prefetch" href="/assets/index.html-BDXrHDOB.js" as="script"><link rel="prefetch" href="/assets/index.html-B5LZd7Tu.js" as="script"><link rel="prefetch" href="/assets/index.html-6jWIt8oc.js" as="script"><link rel="prefetch" href="/assets/index.html-CSdgPEq7.js" as="script"><link rel="prefetch" href="/assets/index.html-DCo5Nv5q.js" as="script"><link rel="prefetch" href="/assets/index.html-Brpt2ZCz.js" as="script"><link rel="prefetch" href="/assets/index.html-Vr2s5cTV.js" as="script"><link rel="prefetch" href="/assets/index.html-CObAnVJq.js" as="script"><link rel="prefetch" href="/assets/index.html-D4vKJClG.js" as="script"><link rel="prefetch" href="/assets/index.html-C7F_lPMW.js" as="script"><link rel="prefetch" href="/assets/index.html-DbhOnD6X.js" as="script"><link rel="prefetch" href="/assets/index.html-BUrcBf3a.js" as="script"><link rel="prefetch" href="/assets/index.html-CQteeJnv.js" as="script"><link rel="prefetch" href="/assets/index.html-BolN-0VV.js" as="script"><link rel="prefetch" href="/assets/index.html-CSA7l4QW.js" as="script"><link rel="prefetch" href="/assets/index.html-ChpFQk3u.js" as="script"><link rel="prefetch" href="/assets/index.html-CE6y20o9.js" as="script"><link rel="prefetch" href="/assets/index.html-Bgozvk6b.js" as="script"><link rel="prefetch" href="/assets/index.html-BnlSuRZv.js" as="script"><link rel="prefetch" href="/assets/index.html-iwlWDpaR.js" as="script"><link rel="prefetch" href="/assets/index.html-BI1uO-q_.js" as="script"><link rel="prefetch" href="/assets/index.html-CJXz38Vo.js" as="script"><link rel="prefetch" href="/assets/index.html-Crj8QFKi.js" as="script"><link rel="prefetch" href="/assets/index.html-CVmlLMGt.js" as="script"><link rel="prefetch" href="/assets/index.html-yHByr8SE.js" as="script"><link rel="prefetch" href="/assets/index.html-Dwt-u5YS.js" as="script"><link rel="prefetch" href="/assets/index.html-Lh3pqQdX.js" as="script"><link rel="prefetch" href="/assets/index.html-5MhpZZor.js" as="script"><link rel="prefetch" href="/assets/index.html-CO192QD8.js" as="script"><link rel="prefetch" href="/assets/index.html-irnz5gtj.js" as="script"><link rel="prefetch" href="/assets/index.html-gBkIKSTb.js" as="script"><link rel="prefetch" href="/assets/index.html-Dt7kO3xP.js" as="script"><link rel="prefetch" href="/assets/index.html-CTQzpgnp.js" as="script"><link rel="prefetch" href="/assets/index.html-D2FO2Atx.js" as="script"><link rel="prefetch" href="/assets/index.html-Uc1ckaLs.js" as="script"><link rel="prefetch" href="/assets/index.html-DF8bCwYZ.js" as="script"><link rel="prefetch" href="/assets/index.html-CgbOwbU9.js" as="script"><link rel="prefetch" href="/assets/index.html-CypESjdB.js" as="script"><link rel="prefetch" href="/assets/index.html-uc4gIoxQ.js" as="script"><link rel="prefetch" href="/assets/index.html-B_xOgHQC.js" as="script"><link rel="prefetch" href="/assets/index.html-Bd3n8Egf.js" as="script"><link rel="prefetch" href="/assets/index.html-B_3BLQJg.js" as="script"><link rel="prefetch" href="/assets/index.html-BsT1oYeM.js" as="script"><link rel="prefetch" href="/assets/404.html-CugTnmpf.js" as="script"><link rel="prefetch" href="/assets/index.html-B-qIo2nY.js" as="script"><link rel="prefetch" href="/assets/index.html-CpRaAOVw.js" as="script"><link rel="prefetch" href="/assets/index.html-CmHxXeua.js" as="script"><link rel="prefetch" href="/assets/index.html-E5DZnHLq.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-GXRgw7eJ.js" as="script"><link rel="prefetch" href="/assets/style-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/assets/docsearch-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/assets/index-DWGeGWcS.js" as="script"><link rel="prefetch" href="/assets/giscus-C26m1eXs.js" as="script"></head><body><div id="app"><!--[--><div class="theme-plume vp-layout" data-v-ab0729e6><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-9ba9c8d4></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-9ba9c8d4> Skip to content </a><!--]--><!----><div class="vp-nav" data-v-ab0729e6 data-v-5204fcda><div class="vp-navbar has-sidebar top" data-v-5204fcda data-v-c0ed9090><div class="wrapper" data-v-c0ed9090><div class="container" data-v-c0ed9090><div class="title" data-v-c0ed9090><div class="vp-navbar-title has-sidebar" data-v-c0ed9090 data-v-939e7c42><a class="vp-link link title" href="/" data-v-939e7c42 data-v-574672f1><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" src="/images/logo.png" alt data-v-74d78946><!--]--><!--[--><img class="vp-image light logo" src="/images/logo.png" alt data-v-74d78946><!--]--><!--]--><!--]--><span data-v-939e7c42>chgoh7的文档&amp;blog</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-c0ed9090><div class="content-body" data-v-c0ed9090><!--[--><!--]--><div class="vp-navbar-search search" data-v-c0ed9090><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-c0ed9090 data-v-c3439201><span id="main-nav-aria-label" class="visually-hidden" data-v-c3439201>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-c3439201 data-v-7c98c2da data-v-574672f1><!--[--><!----><span data-v-7c98c2da>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/" tabindex="0" data-v-c3439201 data-v-7c98c2da data-v-574672f1><!--[--><!----><span data-v-7c98c2da>博客</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-c3439201 data-v-beba1669><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-beba1669><span class="text" data-v-beba1669><!----><!----><span data-v-beba1669>我的文档库</span><span class="vpi-chevron-down text-icon" data-v-beba1669></span></span></button><div class="menu" data-v-beba1669><div class="vp-menu" data-v-beba1669 data-v-7d640523><div class="items" data-v-7d640523><!--[--><!--[--><div class="vp-menu-group" data-v-7d640523 data-v-9869943b><p class="title" data-v-9869943b><!----><span data-v-9869943b>后端</span></p><!--[--><!--[--><div class="vp-menu-link" data-v-9869943b data-v-c026d6d0><a class="vp-link link" href="/notes/JavaSE/" data-v-c026d6d0 data-v-574672f1><!--[--><!----><i data-v-c026d6d0>JavaSE</i><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-9869943b data-v-c026d6d0><a class="vp-link link" href="/notes/JavaEE/" data-v-c026d6d0 data-v-574672f1><!--[--><!----><i data-v-c026d6d0>JavaEE</i><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-9869943b data-v-c026d6d0><a class="vp-link link" href="/notes/Microservices/" data-v-c026d6d0 data-v-574672f1><!--[--><!----><i data-v-c026d6d0>微服务</i><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-9869943b data-v-c026d6d0><a class="vp-link link" href="/notes/DevOps/" data-v-c026d6d0 data-v-574672f1><!--[--><!----><i data-v-c026d6d0>开发|运营工具</i><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-9869943b data-v-c026d6d0><a class="vp-link link" href="/notes/Project/" data-v-c026d6d0 data-v-574672f1><!--[--><!----><i data-v-c026d6d0>项目开发</i><!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="vp-menu-group" data-v-7d640523 data-v-9869943b><p class="title" data-v-9869943b><!----><span data-v-9869943b>其他</span></p><!--[--><!--[--><div class="vp-menu-link" data-v-9869943b data-v-c026d6d0><a class="vp-link link" href="/ydapsgxn/" data-v-c026d6d0 data-v-574672f1><!--[--><!----><i data-v-c026d6d0>markdown语法</i><!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/Webdocs/" tabindex="0" data-v-c3439201 data-v-7c98c2da data-v-574672f1><!--[--><!----><span data-v-7c98c2da>互联网文档</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-c3439201 data-v-beba1669><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-beba1669><span class="text" data-v-beba1669><!----><!----><span data-v-beba1669>探索</span><span class="vpi-chevron-down text-icon" data-v-beba1669></span></span></button><div class="menu" data-v-beba1669><div class="vp-menu" data-v-beba1669 data-v-7d640523><div class="items" data-v-7d640523><!--[--><!--[--><div class="vp-menu-link" data-v-7d640523 data-v-c026d6d0><a class="vp-link link" href="/Discovery/MyTools/" data-v-c026d6d0 data-v-574672f1><!--[--><!----><i data-v-c026d6d0>我的工具</i><!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/Friends/" tabindex="0" data-v-c3439201 data-v-7c98c2da data-v-574672f1><!--[--><!----><span data-v-7c98c2da>友链</span><!--]--><!----></a><!--]--><!--]--></nav><!----><div class="vp-navbar-appearance appearance" data-v-c0ed9090 data-v-69e7a7dc><button class="vp-switch vp-switch-appearance" type="button" role="switch" title="切换为深色主题" aria-checked="false" data-v-69e7a7dc data-v-47c6f954 data-v-a8b7ff70><span class="check" data-v-a8b7ff70><span class="icon" data-v-a8b7ff70><!--[--><span class="vpi-sun sun" data-v-47c6f954></span><span class="vpi-moon moon" data-v-47c6f954></span><!--]--></span></span></button></div><!----><div class="vp-flyout vp-navbar-extra extra" data-v-c0ed9090 data-v-7c170b1b data-v-beba1669><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-beba1669><span class="vpi-more-horizontal icon" data-v-beba1669></span></button><div class="menu" data-v-beba1669><div class="vp-menu" data-v-beba1669 data-v-7d640523><!----><!--[--><!--[--><!----><div class="group" data-v-7c170b1b><div class="item appearance" data-v-7c170b1b><p class="label" data-v-7c170b1b>外观</p><div class="appearance-action" data-v-7c170b1b><button class="vp-switch vp-switch-appearance" type="button" role="switch" title="切换为深色主题" aria-checked="false" data-v-7c170b1b data-v-47c6f954 data-v-a8b7ff70><span class="check" data-v-a8b7ff70><span class="icon" data-v-a8b7ff70><!--[--><span class="vpi-sun sun" data-v-47c6f954></span><span class="vpi-moon moon" data-v-47c6f954></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-c0ed9090 data-v-b3db39d0><span class="container" data-v-b3db39d0><span class="top" data-v-b3db39d0></span><span class="middle" data-v-b3db39d0></span><span class="bottom" data-v-b3db39d0></span></span></button></div></div></div></div><div class="divider" data-v-c0ed9090><div class="divider-line" data-v-c0ed9090></div></div></div><!----></div><div class="vp-local-nav reached-top is-blog" data-v-ab0729e6 data-v-dc24d34a><button class="menu" aria-expanded="false" aria-controls="SidebarNav" data-v-dc24d34a><span class="vpi-align-left menu-icon" data-v-dc24d34a></span><span class="menu-text" data-v-dc24d34a>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-dc24d34a data-v-449b7dce><button data-v-449b7dce>返回顶部</button><!----></div></div><aside class="vp-sidebar" data-v-ab0729e6 data-v-fb20aff4><div class="curtain" data-v-fb20aff4></div><nav id="SidebarNav" class="nav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-fb20aff4><span id="sidebar-aria-label" class="visually-hidden" data-v-fb20aff4> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-3ea47016><section class="vp-sidebar-item sidebar-item level-0" data-v-3ea47016 data-v-571e63c7><!----><div class="items" data-v-571e63c7><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>JavaEE</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/siua3dnm/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>00 软件工程</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-3ea47016><section class="vp-sidebar-item sidebar-item level-0 collapsible" data-v-3ea47016 data-v-571e63c7><div class="item" role="button" tabindex="0" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><h2 class="text" data-v-571e63c7>01 数据库</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-571e63c7><span class="vpi-chevron-right caret-icon" data-v-571e63c7></span></div></div><div class="items" data-v-571e63c7><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/yh28xxk8/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>MySQL</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-3ea47016><section class="vp-sidebar-item sidebar-item level-0 collapsible has-active" data-v-3ea47016 data-v-571e63c7><div class="item" role="button" tabindex="0" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><h2 class="text" data-v-571e63c7>13 缓存</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-571e63c7><span class="vpi-chevron-right caret-icon" data-v-571e63c7></span></div></div><div class="items" data-v-571e63c7><!--[--><section class="vp-sidebar-item sidebar-item level-1 collapsible is-link has-active" data-v-571e63c7 data-v-571e63c7><div class="item" tabindex="0" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/2pi2mia2/" data-v-571e63c7 data-v-574672f1><!--[--><h3 class="text" data-v-571e63c7>Redis</h3><!--]--><!----></a><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-571e63c7><span class="vpi-chevron-right caret-icon" data-v-571e63c7></span></div></div><div class="items" data-v-571e63c7><!--[--><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/rytrjgmy/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>01-基础知识</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/rb58wsma/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>02-NoSQL数据库</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/xkgdyn6w/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>03-安装和指令</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/54zt20sc/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>04-五大数据类型</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/j53m044p/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>05-Redis配置</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/3or4nv5k/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>06-发布和订阅</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/vah7cu0t/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>07-Jedis</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/addjlra9/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>08-SpringBoot整合Redis</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/35awoyu3/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>09-持久化RDB和AOF</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/qbw59gib/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>10-事务和锁机制</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/ohdbiliq/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>11-主从复制</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/bgtjjvwi/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>12-Redis集群</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/k6kk3ojb/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>13-集成Redis的应用问题&解决方案</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/r16wxwkt/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>14-Redis的新功能</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-2 is-link" data-v-571e63c7 data-v-571e63c7><div class="item" data-v-571e63c7><div class="indicator" data-v-571e63c7></div><!----><a class="vp-link link link" href="/notes/JavaEE/qc3p4bmv/" data-v-571e63c7 data-v-574672f1><!--[--><p class="text" data-v-571e63c7>15-Redis实战案例</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><!--[--><div id="VPContent" vp-content class="vp-content has-sidebar" data-v-ab0729e6 data-v-18f134a7><div class="has-sidebar has-aside vp-doc-container" data-v-32f0cf3f><!--[--><!--]--><div class="container" data-v-32f0cf3f><div class="aside" data-v-32f0cf3f><div class="aside-curtain" data-v-32f0cf3f></div><div class="aside-container" data-v-32f0cf3f><div class="aside-content" data-v-32f0cf3f><div class="vp-doc-aside" data-v-32f0cf3f data-v-7b1983db><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="vp-doc-aside-outline" role="navigation" data-v-7b1983db data-v-4a7bfa3f><div class="content" data-v-4a7bfa3f><div class="outline-marker" data-v-4a7bfa3f></div><div id="doc-outline-aria-label" aria-level="2" class="outline-title" role="heading" data-v-4a7bfa3f><span data-v-4a7bfa3f>此页内容</span><span class="vpi-print icon" data-v-4a7bfa3f></span></div><ul class="root" data-v-4a7bfa3f data-v-fdfcd51c><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-7b1983db></div><!--[--><!--]--></div></div></div></div><div class="content" data-v-32f0cf3f><div class="content-container" data-v-32f0cf3f><!--[--><!--]--><main class="main" data-v-32f0cf3f><nav class="vp-breadcrumb" data-v-32f0cf3f data-v-6d968b62><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-6d968b62><!--[--><li property="itemListElement" typeof="ListItem" data-v-6d968b62><a class="vp-link link breadcrumb" href="/" property="item" typeof="WebPage" data-v-6d968b62 data-v-574672f1><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-6d968b62></span><meta property="position" content="1" data-v-6d968b62></li><li property="itemListElement" typeof="ListItem" data-v-6d968b62><span class="vp-link breadcrumb" href="/" property="item" typeof="WebPage" data-v-6d968b62 data-v-574672f1><!--[-->13 缓存<!--]--><!----></span><span class="vpi-chevron-right" data-v-6d968b62></span><meta property="position" content="2" data-v-6d968b62></li><li property="itemListElement" typeof="ListItem" data-v-6d968b62><a class="vp-link link breadcrumb" href="/notes/JavaEE/2pi2mia2/" property="item" typeof="WebPage" data-v-6d968b62 data-v-574672f1><!--[-->Redis<!--]--><!----></a><span class="vpi-chevron-right" data-v-6d968b62></span><meta property="position" content="3" data-v-6d968b62></li><li property="itemListElement" typeof="ListItem" data-v-6d968b62><a class="vp-link link breadcrumb current" href="/notes/JavaEE/k6kk3ojb/" property="item" typeof="WebPage" data-v-6d968b62 data-v-574672f1><!--[-->13-集成Redis的应用问题&amp;解决方案<!--]--><!----></a><!----><meta property="position" content="4" data-v-6d968b62></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-aa52ef30>13-集成Redis的应用问题&amp;解决方案</h1><div class="vp-doc-meta" data-v-aa52ef30><p class="reading-time" data-v-aa52ef30><span class="vpi-books icon" data-v-aa52ef30></span><span data-v-aa52ef30>3847字</span><span data-v-aa52ef30>约13分钟</span></p><!----><p class="create-time" data-v-aa52ef30><span class="vpi-clock icon" data-v-aa52ef30></span><span data-v-aa52ef30>2024-08-29</span></p></div><!--]--><div class="vp-doc plume-content _notes_JavaEE_k6kk3ojb_" data-v-32f0cf3f><h2 id="缓存穿透" tabindex="-1"><a class="header-anchor" href="#缓存穿透"><span>缓存穿透</span></a></h2><p><img src="/assets/image-20240902150233846-hFY-EEYX.png" alt="image-20240902150233846"></p><p><strong>缓存穿透的原因</strong></p><p>key 对应的数据在数据源并不存在，每次针对此 key 的请求从缓存获取不到，请求都会压到数据源, 可能压垮数据源</p><p>比如用一个不存在的用户 id 获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库</p><p>如果从存储层查不到数据则不会写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询, 失去了缓存的意义</p><p><strong>缓存穿透的现象/表象</strong></p><ul><li>应用服务器压力变大</li><li>Redis 命中率降低</li><li>一直查数据库</li></ul><p><strong>解决方案</strong></p><ul><li>对空值缓存</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>思路：如果一个查询返回的数据为空，我们仍然把这个空结果（null）进行缓存，设置空结果的过期时间应该短些，最长不超过五分钟或者在查询该 key 对应的数据 insert 后再进行清理缓存</p></div><ul><li>设置可访问的名单(白名单)</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>思路：定义一个可以访问的名单，每次访问和白名单的 id 进行比较，如果访问id 不在白名单里面，进行拦截，不允许访问, 比如使用 bitmaps 实现.</p></div><ul><li>采用布隆过滤器</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>特点：布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般的算法，缺点是有一定的误识别率和删除困难</p><p>思路：在查询的时候先去布隆过滤器查询 key 是否存在，如果不存在就直接返回，存在再查缓存和DB（推荐）</p></div><ul><li>进行实时监控</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>当发现 Redis 的命中率开始急速降低, 需要排查访问对象和访问的数据, 和运维人员配合, 可以设置黑名单限制服务</p></div><div class="hint-container info"><p class="hint-container-title">建议</p><p>一般性的采用 <code>空值缓存</code> 和 <code>布隆过滤器</code> 的方案</p></div><h2 id="缓存击穿" tabindex="-1"><a class="header-anchor" href="#缓存击穿"><span>缓存击穿</span></a></h2><p><img src="/assets/image-20240902150803434-BWZ3-yvV.png" alt="image-20240902150803434"></p><blockquote><p>缓存击穿，指的是在缓存失效的同时，有大量的并发读请求，这些读请求会在同一时间穿透缓存层到达数据库，使数据库的压力变大，严重的时候，会导致数据库宕机。</p></blockquote><p>比如某个热点数据, 可能会在某些时间点, 被超高并发地访问, 容易出现缓存击穿</p><p><strong>缓存击穿的现象/表象</strong></p><ul><li>数据库访问压力瞬时增加</li><li>Redis 里面没有出现大量 key 过期</li><li>Redis 正常运行状态, 但是数据库可能瘫痪了</li></ul><p><strong>解决方案</strong></p><ul><li>预先设置热门数据</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>在 redis 高峰访问之前，把一些热门数据提前存入到 redis 里面，加大这些热门数据key的时长</p></div><ul><li>实时调整</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>现场监控哪些数据热门，实时调整 key 的过期时长</p></div><ul><li>用锁控制访问的线程</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>在缓存失效的时候（判断拿出来的值为空），不是立即去load db。先使用缓存工具的某些带成功操作返回值的操作（比如 Redis 的SETNX）去set 一个mutexkey</p><p>当操作返回成功时，再进行 load db 的操作，并回设缓存,最后删除mutex key；</p><p>当操作返回失败，证明有线程在 load db，当前线程睡眠一段时间再重试整个get 缓存的方法</p><p>但是使用锁效率会有影响</p></div><div class="hint-container info"><p class="hint-container-title">建议</p><p>一般采用分布式锁来控制访问线程的方案</p></div><h2 id="缓存雪崩" tabindex="-1"><a class="header-anchor" href="#缓存雪崩"><span>缓存雪崩</span></a></h2><p><img src="/assets/image-20240902151944614-BxBRpJly.png" alt="image-20240902151944614"></p><p><img src="/assets/image-20240902152011901-BqJIZ7LZ.png" alt="image-20240902152011901"></p><blockquote><p>当缓存服务器重启或者大量缓存集中在某一个时间段失效，这样在失效的时候，也会给后端系统(比如 DB)带来很大压力</p></blockquote><div class="hint-container info"><p class="hint-container-title">区分缓存击穿</p><p>缓存雪崩与缓存击穿的区别在于这里针对很多 key 缓存</p></div><p><strong>缓存雪崩的现象/表象</strong></p><ul><li><p>数据库访问压力变大, 服务器崩溃</p></li><li><p>在极短时间内, 访问大量 Key, 而这些 Key 集中过期</p></li></ul><p><strong>解决方案/思路</strong></p><ul><li>构建多级缓存架构</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>nginx 缓存 + redis 缓存 +其他缓存（ehcache 等） , 这种方式开发/维护成本较高</p></div><ul><li>使用锁或队列</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>用加锁或者队列的方式来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上。</p></div><div class="hint-container caution"><p class="hint-container-title">警告</p><p>不适用高并发情况</p></div><ul><li>设置过期标志更新缓存</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>记录缓存数据是否过期，如果过期会触发通知另外的线程在后台去更新实际key 的缓存。</p></div><ul><li>将缓存失效时间分散开</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>可以在原有的失效时间基础上增加一个随机值，比如1-5 分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件</p></div><div class="hint-container info"><p class="hint-container-title">建议</p><p>一般采用给不同的key设置不同过期时间来避免缓存雪崩</p></div><h2 id="分布式锁" tabindex="-1"><a class="header-anchor" href="#分布式锁"><span>分布式锁</span></a></h2><h3 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h3><p>单体单机部署的系统被演化成分布式集群系统后，由于分布式系统多线程、多进程并且分布在不同机器上，这将使原单机部署情况下的并发控制锁策略失效，单纯的 Java API 并不能提供分布式锁的能力</p><p>为了解决这个问题就需要一种跨 JVM 的互斥机制来控制共享资源的访问，这就是分布式锁要解决的问题</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>我们探讨的分布式锁是针对分布式项目/架构而言</p></div><p><img src="/assets/image-20240902154657504-C0XvPq3W.png" alt="image-20240902154657504"></p><p><img src="/assets/image-20240902154721928-DB_uySRk.png" alt="image-20240902154721928"></p><h3 id="分布式锁主流实现方案" tabindex="-1"><a class="header-anchor" href="#分布式锁主流实现方案"><span>分布式锁主流实现方案</span></a></h3><ol><li><p>基于数据库实现分布式锁</p></li><li><p>基于缓存（Redis 等）</p></li><li><p>基于 Zookeeper</p></li></ol><div class="hint-container tip"><p class="hint-container-title">提示</p><p>性能：redis 最高 可靠性：zookeeper 最高</p></div><p><strong>Redis 实现分布式锁</strong></p><ol><li>指令:<code>setnx key value</code></li></ol><p>setnx 可以理解是上锁/加锁指令，key 是锁的键，value 是锁的值，在这个 key 没有删除前, 不能执行相同 key 的上锁指令.</p><ol start="2"><li>指令: <code>del key</code></li></ol><p>就是删除 key, 可以理解成就是释放锁</p><img src="/assets/image-20240902155359315-D8JfY56n.png" alt="image-20240902155359315" style="zoom:150%;"><p>可以看到，设置了lock:1这把锁，如果不进行删除就会导致后面的重新设置这个值的操作失败</p><img src="/assets/image-20240902155848971-B3C1FX1V.png" alt="image-20240902155848971" style="zoom:150%;"><p>可以看到删除该键后（相当于释放锁）又可以重新设置这个键值</p><ol start="3"><li>指令: <code>expire key seconds</code></li></ol><p>给锁-key ，设置过期时间，目的是防止死锁</p><ol start="4"><li>指令：<code>ttl key</code></li></ol><p>查看某个锁-key，过期时间，过期后删除原来设置的 key-value</p><p>比如：setnx lock:1 100 ，expire lock:1 60（设置60秒过期），然后期间ttl就可以实时查看当前过期的剩余时间</p><ol start="5"><li>指令：<code>set key value nx ex seconds</code></li></ol><p>设置锁的同时, 指定该锁的过期时间，防止死锁，过期时间到后, 会自动删除</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>这个指令是原子性的，防止<code> setnx key value / expire key seconds</code> 两条指令中间执行被打断。</p></div><h3 id="实例" tabindex="-1"><a class="header-anchor" href="#实例"><span>实例</span></a></h3><h4 id="springboot集成redis实现分布式锁" tabindex="-1"><a class="header-anchor" href="#springboot集成redis实现分布式锁"><span>Springboot集成Redis实现分布式锁</span></a></h4><p>模拟一个并发需求，几个线程任务同时操作一个业务</p><p>思路：</p><ol><li>获取到分布式锁</li></ol><p>该情况执行正常业务，在开始阶段先设置一下锁key（获取锁），然后执行正常业务逻辑，最后再释放锁。</p><ol start="2"><li>没有获取到分布式锁</li></ol><p>线程休眠几秒，然后重新尝试获取锁，如果还没有获取到就再次重复以上过程。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">GetMapping</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/testLock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> viod </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">testLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(){</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	//获取锁，setnx操作</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	Boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setIfAbsent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ok</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">	if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		Object</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">num</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">StringUtils</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">isEmpty</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">       		 return</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> num</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Integer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">parseInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">value </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">num</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ++</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">num</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        //释放锁</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">delete</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">		//获取锁失败、每隔 0.1 秒再获取</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">                Thread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sleep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">100</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            	testLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">InterruptedException </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">printStackTrace</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用ab工具测试：</p><p><code>ab -n 1000 -c 100 http://192.168.198.1:8080/redisTest/testLock</code></p><blockquote><p>192.168.198.1 是 linux 访问本机的地址</p></blockquote><img src="data:image/png;base64,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" alt="image-20240902162804943" style="zoom:150%;"><div class="hint-container caution"><p class="hint-container-title">警告</p><p>以上代码容易造成死锁的产生</p></div><h4 id="堆栈溢出问题" tabindex="-1"><a class="header-anchor" href="#堆栈溢出问题"><span>堆栈溢出问题</span></a></h4><p><strong>递归调用</strong>：在获取锁失败时，代码使用递归调用 <code>testLock()</code>。在每次调用前会进行 <code>Thread.sleep(100);</code> 的等待，但由于递归调用并没有限制重试的次数，可能会导致栈溢出，进而导致应用程序崩溃，可以采用循环重试的方式代替递归方式或者限制重试的次数。</p><h4 id="死锁问题" tabindex="-1"><a class="header-anchor" href="#死锁问题"><span>死锁问题</span></a></h4><p>分析如上代码，没有考虑异常情况。如果某一次的业务操作失败（堆栈异常），后续的逻辑中断了。锁没有成功释放，其他线程任务无法获取锁。</p><p>优化</p><ul><li><p>在发生异常的时候释放锁，利用finally</p></li><li><p>可以设置锁的过期时间来防止死锁情况的产生。</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//获取锁，setnx操作，设置过期时间为3秒</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setIfAbsent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ok</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> TimeUnit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">SECONDS</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>使用ab工具测试：</p><p><code>ab -n 1000 -c 100 http://192.168.198.1:8080/redisTest/testLock</code></p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAABJCAIAAAA15rowAAAL1klEQVR4nO2caVAb1x3A/6vVgQ5AFwIJkBDCYGRz+AB8EMf4dmzXjsdukpkk4zTHTBqnTTOTzvRTO5NOO53ph7T50knTpknGuRwftZ34JD4xBhsbMOaQuS/d50q7q2O1/QA2whjDyikOO/sbvuzT+7/32J9233933wopXLoCONgL70kPgOP/CyeY5XCCWQ4nmOVwglkOJ5jlcIJZDieY5XCCWQ4nmOVwglkOJ5jlcIJZDieY5cwnwVkrnt//zournvQw5hfzSbAst2CBVil70sOYXyQluPL5/TtWZqA//mgeDQ/lozwEmetu5zdIMis6yl/5424D+GzNP3x/tHkwNus4fsbKbVuXlWqlfB4A6W+v+9668IX12Y7aP39yabyKKGf13l0V2RliAADSPVL33cFLI2Ew7nnveZNCKk8TxXFPgACAkcbff3Z+Sg81r/2uUtF2/O8tOS9sLzWmowBA2i3/PXCkPQwAMNaO98JfPq6fiDHueGffYv+9MZj3/GpHia/x/VrBiztLjekoxMPW1oufnLxFZW8aLwEIDt768qszwxTjPTf3oCptDuMgd/fN9pC0sGTlstKlBTrK1Tfkj84cpah59dX1S7PFgf4+y7DXQ6mLK8uLVEpFWqT3bEMPAIBowY43Xl9jVJC2Novd5uNpTKaScpPQcuNuSK6Q0BGxRptK9jX19Dp9juH+9iHHlD4W1excqIS08ooCdKSv1+oPSHRFBl1xrqDhZk8EADRV26tz4/3n6vsmYjRLt9SY6HtjyK7cXFnAF2jL8mW2vl5rWJSTZ8oz6BDZki1VWb6BziFvQKIrzteb1eErbcNxxvturuEnExQN+mzXT3x2p860+bntJTv3GVf3NH377Zm+8CNiVGt2VZvVVMfBj75qx6IUICj/nPm5d/cqJqoYd+6t0vG6T/31UFMoGqcR3pmmbW+9UVa9fuV3X9yoPd1csLt4qRbrOX38BwCIT/uVkmWreg//6+s7WCwOiKAt9ubLq02LazRnjk/9PkyHRgXHPvqkGYvFEX7T5l++VWleuzJoqf3g8HWcAkTQLfj1z5eYFy+F+sZZN/mkSDbJoiME5rO2Hf/4w3980xKUmVa//u47+9aYRdPVR5eUFUphsPmbZkcghBMkjocCzuYj9baJKiWV5ixRoPlUvRML4iROEEH/wJnbTlRmKDDSEZLEI3EAoGMkTpA4EZlWMM9599tmB4bjBInjWGdDrw/4MoWSyX9HWJtujLUQwkYaez2IIIVoO1vvHhs51nprkERS5LkaJm0+IZI6gu9Bx3DMT7RcvKySb926KLOsevntS+1ND62q12n4iHfwli9KTxRG3eHIxFamKoUHwuWv/sY8ceLjidMA4cmNAH0wWzBbX0Iv1ICXAEhTZgJ0zroJr/125F4L9ChGAADht98fazQUoQERS9MAZn9WeEI8lmBA9Us2bdpQnqXm0711Jw5dbHFPV1OAogBB3DO5lE7cQHkIhL0dbYPYg8Hu2dsFADo+Ke2jaBqAhzLK+eOJE0CcBgCgafqBSjzefLjGTFbwmNqyLJWEZ2+t+/f5G6MhIkhGHtwJ96FiAKDILAFoSChVpQgnNshwDISIr/74ycCDwRH4MZErCgEs97ZEOYppJxYWkJTghXve27VQJROGLNc+P3t10EfgRHiGS4aB/kF8sbmoYo2i4ZJ3vExUumV5wjTWdNe2q1Bbsqrg2NHW6S+9pAo9wGAyowYAcAYJgIycYjlYfGMlivXL9PPhSEyWpASr1Yrg3YOfnu4OkEGcpKY9bBOINR6tqyjaoNv++v7cFouNgJSswrJ8BPOAImO8SrD+7MWyl9Yt3/XbrNKWdgcJAGLlAkMWefuD/9QDAAy5/ACa8q3POjvIrFTywHdTr4Nnwnetaaj8Gd2y/a+JGy0eSqwpKdOLvCRkzCJ2fpKU4FsHP+yIeTz+8GzUjhN21H32T/rZnZX68pXKaByimLf19JFY9dv6iSo9tV8djWxet8JU9JQmPw4Qi8XCrsELQ+OfE9dqzxTuqjGUrc+k431Xkhk5bb309Unpc+tW5plrdDE6ivU3nryq2/kyewUndScrWVCxQpkqEvIRAKCjEcyHr3rzDztyR4+897fa8SpCSXp6mpiP8gAA6DhNRYiA30+MTwACqVKZnsJDAGgCG/UGp/SQlqGT8nGf1UdMlMnU2WmCSMDqHK+ekqpKTxXyEAQgHiP8vpBIpZbEAqMuDABArMyUi6nQiGsiEUhVa9OE0XsVAABE8iy1BAi3zfOoS/+fBI+XRTOEIrzOhD0P6GqDGsDr6Z8oiuB+J+6froFoyGMPPaqHgHP0wQwNgq6RSd8EEnOTkxJ1wjbim9jw2BOHCACAuawPJPZhX2LIT5onmF+I8jdWFaaAr6ct6ZyJY0bm7gjWb9j3TGbEbrW6CQBBana+ocioRr1dx0+1z+JGNkeSzJ3gYASR5xbqTQUAAAjKo0h7x6XDF691+X/y89h8Zu6SLJ5EoZaJ+Cgy9kSXpqgwEfQH8Nk/beRIgrk7guO414HPWW8c47D5Jg4HJ5j9cIJZDieY5XCCWQ4nmOVwglkOJ5jlJHGjQ5hVurGmPEsjQQEgFiWsrfUnrncnrqpBM6u3rS3IVQj5ALGQr6vx4rkue8Lnmeann64skKcLAOIRz3D32dNXbNTswzkYwHzhe+nut7aW61Nppx0Lkmiawbgw36AXeJr73GOP/1HDll/sXVGuE/sdPn9ErDWZFuRnCkfauv1jDjMrnt3zs4o8VTQw6g3TqfriQn2+PHqnYzg8q3AOZjAXnLe81FV78MKN1o5OS4+lsxNTlS9ZZEhxX2keoQFAv3bP9qdyQvUHvj7d2tHZ3XVnVFFSWVCgQlubunEA1Lz9lU1FKQM/fHrscmuXpcvSE9ItqyrSipzX7zioGcM5mMJ8Dm4/dehaR+/QqNPrcnsdo4PXm4bC/NRskw4AAHKWrzRJQnfrz3UP29wut9s21P791QEkNW/hUhUACJdVmDME9oaTDT02h9vrctp6rp7t8aUoy0pLZhHOwRjmgjGHI5R4tsSD4TgADxUCAEgWGDQCarSr1X9/8XrU1dDvAYG6YAEAmAtzU3g+2w176N5yrjg+aBnBEVluYc7M4RyMefwsWl+kFQLh7h0BANCoZHwIOnonnU2xYV8IBBqtESBTJYOwy2FPXK1H3R71Ak+uNMwczsGYxxQszFu3dUUGWG9dbSUBAPQqMQARdE2uFaYoAIEwDXLUShQiId/kfCkYiQHw+dIZwzmY8xjPg1GdecPGnVV66Ll84HzH2Lo2sQAFiMcfmvAiCEiEAgCafng+jMwYzsGcJAWjyoptO1aVGVKxmycPNrQM+MaX3fhxCgAFFGCKpFgEBw9OAqQgD3tPiIqFAchHh3MwJxnBQuOWF7eVm6RY4/HPG7vtNoy8P6X6cRJAoswFSFgKC0qJBKhB1yB4iwgApVwz2aAxXQaABYYBBI8O52AO8zk4Y91Lu6sKeX2Hvjh0vm3AmmAXAPoHXGGQ5OTLEyOK9Go++IfukkC1D3uAr9ZMyoilxbnpELYND80YzsEcpoKFpWtXLFZ46w6faR2yBaasdyVuW/oJVFteU3T/NJxe/XSRODZy95IDAAbrLF6QGtetyLzfYF71omw+bmloCs8czsEYpneyCtbsqMqnnO3WWHpmji4r4U8Ko14MIt6AwlyxQJutVIjEcpXOvHpNVYmGbD5xrN4WAoiH3Cl5S4qM2RlKsTQlTWssq9603CAZbvjyfJs/BjOFczCG6bLZDW//aWNRPGj3T3lld6Th/S8uAABflV9RvW1zeQZKhiIgFNO+W5fPXmzqdIxHpOcUr1q/tWKRNIaRFCoUhgdunjxf1zLiGzvVzxTOwQymgjNNi1TSh36Cu1v7xp/5COT6vCyZGAUAoMjg6PCwN5zwezRIqsag1Uj4PAQgHgu67f0Of+LP1cwQzsGEOX27kGPu4R74sxxOMMvhBLMcTjDL4QSzHE4wy+EEsxxOMMvhBLMcTjDL4QSzHE4wy+EEsxxOMMv5H/tXZKXpkKZxAAAAAElFTkSuQmCC" alt="image-20240902163436763" style="zoom:150%;"><h4 id="误删锁问题-锁唯一性" tabindex="-1"><a class="header-anchor" href="#误删锁问题-锁唯一性"><span>误删锁问题-锁唯一性</span></a></h4><p>问题分析：</p><img src="/assets/image-20240902165725734-mp-UtAx5.png" alt="image-20240902165725734" style="zoom:67%;"><p>分析：在获取锁的时候, 给锁设置的值是唯一的 <code>uuid</code>，在释放锁时,判断释放的锁是不是同一把锁，造成这个问题的本质原因, 是因为删除操作缺乏原子性</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">GetMapping</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">testLock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> testLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    //1 获取锁，setnx</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    //得到一个 uuid 值，作为锁的值</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> uuid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> UUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">randomUUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">toString</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    Boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setIfAbsent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> uuid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> TimeUnit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">SECONDS</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    //2 获取锁成功、查询 num 的值</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        Object</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">num</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        //2.1 判断 num 为空 return</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">StringUtils</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">isEmpty</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        	return</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      	}</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        //2.2 有值就转成成 int</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> num</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Integer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">parseInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">value </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        //2.3 把 redis 的 num 加 1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        韩顺平Java 工程师redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">num</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ++</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">num</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        //2.4 释放锁，del</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        //为了防止误删锁, 进行判断</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        //判断当前这个锁是不是前面获取到的锁, 相同才进行删除/释放</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">uuid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">equals</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">((</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">String</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">                redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">delete</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    	}</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          //3 获取锁失败、每隔 0.1 秒再获取</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            Thread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sleep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">100</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            testLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">InterruptedException </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">printStackTrace</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      	}</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用ab工具测试：</p><p><code>ab -n 1000 -c 100 http://192.168.198.1:8080/redisTest/testLock</code></p><img src="data:image/png;base64,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" alt="image-20240902170318759" style="zoom:150%;"><h4 id="原子性问题" tabindex="-1"><a class="header-anchor" href="#原子性问题"><span>原子性问题</span></a></h4><img src="/assets/image-20240902170515078-BbY3_hCR.png" alt="image-20240902170515078" style="zoom:67%;"><p>分析：</p><ol><li>删除操作缺乏原子性</li><li>使用 Lua 脚本保证删除原子性</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">GetMapping</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">testLock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> testLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //1 获取锁，setnx</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //得到一个 uuid 值，作为锁的值</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> uuid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> UUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">randomUUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">toString</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            Boolean</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setIfAbsent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> uuid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> TimeUnit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">SECONDS</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //2 获取锁成功、查询 num 的值</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">lock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            Object</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">num</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                //2.1 判断 num 为空 return</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">                if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">StringUtils</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">isEmpty</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">                   return</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      		  //2.2 有值就转成成 int</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">            int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> num</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Integer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">parseInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">value </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         	//2.3 把 redis 的 num 加 1</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">num</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ++</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">num</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //2.4 释放锁，del</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //=====使用 lua 脚本来锁, 控制删除原子性========</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            // 定义 lua 脚本</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> script</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            // 使用 redis 执行 lua 执行</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            DefaultRedisScript</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Long</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> redisScript</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> DefaultRedisScript</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            redisScript</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setScriptText</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">script</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            // 设置一下返回值类型 为 Long</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            // 因为删除判断的时候，返回的 0,给其封装为数据类型。如果不封装那么默认返回String类型，</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            // 那么返回字符串与 0 会有发生错误。</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            redisScript</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setResultType</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Long</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">class</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            // 第一个是 script 脚本 ，第二个需要判断的 key，第三个就是key 所对应的值//Arrays.asList(&quot;lock&quot;) 会 传 递 给 script 的 KEYS[1] , uuid 会传递给ARGV[1] </span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            redisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">execute</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">redisScript</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Arrays</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">asList</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">),</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> uuid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //=====为了防止误删锁, 进行判断====</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">           //判断当前这个锁是不是前面获取到的锁, 相同才进行删除/释放</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //if (uuid.equals((String) redisTemplate.opsForValue().get(&quot;lock&quot;))) {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            // redisTemplate.delete(&quot;lock&quot;);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //}</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //=======================</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //3 获取锁失败、每隔 0.1 秒再获取</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">                Thread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sleep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">100</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                testLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">InterruptedException </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">                e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">printStackTrace</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Lua脚本解析：</p><ul><li>如果服务器返回OK，当前客户端获得锁</li><li>服务端返回NIL，客户端获取锁失败，可以在稍后重试</li></ul><p>设置过期的时间达到自动释放锁</p><p>通过以下优化可以使该锁更加健壮：</p><ul><li>不使用规定的字符串作为键的值，而是设置一个不可猜测（non-guessable）的长随机字符串，作为token。</li><li>不使用 <code>DEL</code> 命令释放锁，而是发送一个 <code>Lua</code> 脚本，这个脚本只在客户端传入的值和键的token匹配时才对键进行删除。</li></ul><p>使用ab工具测试：</p><p><code>ab -n 1000 -c 100 http://192.168.198.1:8080/redisTest/testLock</code></p><img src="data:image/png;base64,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" alt="image-20240902171906106" style="zoom:150%;"><h4 id="小结" tabindex="-1"><a class="header-anchor" href="#小结"><span>小结</span></a></h4><ul><li>定义锁的 key</li></ul><p>key 可以根据业务, 分别设置，比如操作某商品, key 应该是为每个sku定义的，也就是每个 sku 有一把锁</p><details class="hint-container details"><summary>sku是什么</summary><p><strong>SKU</strong> (Stock Keeping Unit) 是库存单位的缩写，是指商品管理中的最小库存单元。SKU 通常用于标识和区分不同的商品，包括商品的型号、规格、颜色等属性。</p><p>在电商平台、仓储系统或商品管理系统中，SKU 是用来唯一标识一个具体商品的编号。例如，同一种产品可能有不同颜色和不同尺寸，这些不同的版本就会有不同的 SKU 编号。</p><p>具体特点：</p><ul><li><strong>唯一性</strong>：每个 SKU 都是唯一的，可以帮助商家跟踪库存、销售情况等。</li><li><strong>层次性</strong>：SKU 可以细分到商品的不同属性，比如同款衣服的不同颜色和尺码，可能对应不同的 SKU。</li><li><strong>管理性</strong>：在商品管理系统中，通过 SKU，可以实现商品的库存管理、销售统计等功能。</li></ul><p>举例：</p><ul><li>一双鞋的基本型号是 &quot;运动鞋&quot;，那么： <ul><li>红色、42 码的鞋子 SKU 可能是：SHOES-RED-42</li><li>蓝色、40 码的鞋子 SKU 可能是：SHOES-BLUE-40</li></ul></li></ul><p>通过 SKU，商家可以精确管理每个具体商品的库存和销售情况。</p></details><ul><li>为了确保分布式锁可用，要确保锁的实现同时满足以下四个条件: <ul><li>互斥性。在任意时刻，只有一个客户端能持有锁。</li><li>不会发生死锁。即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁。</li><li>加锁和解锁必须是同一个客户端，A 客户端不能把 B 客户端加的锁给解了</li><li>加锁和解锁必须具有原子性</li></ul></li></ul></div></main><footer class="vp-doc-footer" data-v-32f0cf3f data-v-eff6f19b><!--[--><!--]--><div class="edit-info" data-v-eff6f19b><div class="edit-link" data-v-eff6f19b><a class="vp-link link edit-link-button" href="https://github.com/ChGoh7/ChGoh7.github.io/edit/docs/docs/notes/JavaEE/13 缓存/Redis/13-集成Redis的应用问题&amp;解决方案.md" target="_blank" rel="noreferrer" data-v-eff6f19b data-v-574672f1><!--[--><span class="vpi-square-pen edit-link-icon" aria-label="edit icon" data-v-eff6f19b></span> 编辑此页<!--]--><!----></a></div><!----></div><div class="contributors" data-v-eff6f19b><span class="contributors-label" data-v-eff6f19b>贡献者: </span><span class="contributors-info" data-v-eff6f19b><!--[--><!--[--><span class="contributor" data-v-eff6f19b>chgoh7</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-eff6f19b><div class="pager" data-v-eff6f19b><a class="vp-link link pager-link prev" href="/notes/JavaEE/bgtjjvwi/" data-v-eff6f19b data-v-574672f1><!--[--><span class="desc" data-v-eff6f19b>上一页</span><span class="title" data-v-eff6f19b>12-Redis集群</span><!--]--><!----></a></div><div class="pager" data-v-eff6f19b><a class="vp-link link pager-link next" href="/notes/JavaEE/r16wxwkt/" data-v-eff6f19b data-v-574672f1><!--[--><span class="desc" data-v-eff6f19b>下一页</span><span class="title" data-v-eff6f19b>14-Redis的新功能</span><!--]--><!----></a></div></nav></footer><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:none;" data-v-32f0cf3f><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" preserveAspectRatio="xMidYMid" viewBox="0 0 100 100"><circle cx="28" cy="75" r="11" fill="currentColor"><animate attributeName="fill-opacity" begin="0s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></circle><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 47a28 28 0 0 1 28 28"><animate attributeName="stroke-opacity" begin="0.1s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 25a50 50 0 0 1 50 50"><animate attributeName="stroke-opacity" begin="0.2s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path></svg></div><!--[--><!--]--></div></div></div></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-ab0729e6 data-v-4486cce5><span class="percent" data-v-4486cce5>0%</span><span class="show icon vpi-back-to-top" data-v-4486cce5></span><svg aria-hidden="true" data-v-4486cce5><circle cx="50%" cy="50%" style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-4486cce5></circle></svg></button><footer class="vp-footer has-sidebar" data-v-ab0729e6 data-v-b2971b30><div class="container" data-v-b2971b30><p class="message" data-v-b2971b30>Power by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></p><!----></div></footer><!--[--><!--]--><!--]--></div><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-CpHCUsvl.js" defer></script></body></html>